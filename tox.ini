[tox]
minversion = 3.1.0
toxworkdir = {env:TOX_WORKDIR:{toxinidir}/.tox}
envlist = py{27,35,36,37},py{27,35,36,37}-{min}

[base]
commands =
    pip freeze
    py.test src/secml {posargs}

[testenv]
platform = linux: linux
           macos: darwin
skip-missing-interpreter = True
usedevelop = {env:TOX_USEDEVELOP:True}
# Set `recreate` as True to recreate the virtualenvs if needed
recreate = False
extras =
    unittests
    !noextras: pytorch,cleverhans
commands =
    {min,n15}: pip install numpy~=1.15.0
    n16: pip install numpy~=1.16.0
    {min,scy2}: pip install scipy~=1.2.0
    {min,sk20}: pip install scikit-learn~=0.20.0
    {min}-!noextras: pip install torchvision==0.2.2
    {min,torch11}-!noextras: pip install torch~=1.1.0
    torch13-!noextras: pip install torch~=1.3.0
    {min,tf114}-!noextras: pip install tensorflow~=1.14.0
    {min,clh}-!noextras: pip install cleverhans
    gpu-!noextras: pip install tensorflow-gpu~=1.14.0
    {[base]commands}

[testenv:min]
description = env with minimum versions of dependencies and extras (python 3.5)
basepython = python3.5

[testenv:min-noextras]
description = env with minimum versions of dependencies and no extras (python 3.5)
basepython = python3.5

[testenv:latest]
description = env with latest versions of dependencies (python 3.5)
basepython = python3.5

[testenv:latest-gpu]
description = env with latest versions of dependencies and extra gpu support (python 3.5)
basepython = python3.5

[testenv:py2-min]
description = env with minimum versions of dependencies and extras (python 2.7)
basepython = python2

# Latest
[testenv:py2-latest]
description = env with latest versions of dependencies (python 2.7)
basepython = python2

# Documentation
[testenv:docs]
description = invoke sphinx-build to build the HTML docs
basepython = python3.5
usedevelop = {env:TOX_USEDEVELOP:True}
recreate = False
deps = -rdocs/requirements.txt
passenv = SECML_ISRELEASE
commands =
;    rm -r docs/build
;    sphinx-apidoc -M -o docs/source/ src/secml/ '_*' "*tests"  # Build addition sources
    sphinx-build -E -c docs/source/ -b html docs/source/ docs/build/html

# Release tooling
[testenv:build]
basepython = python3.5
skip_install = true
recreate = False
deps =
    setuptools
    twine
passenv = SECML_ISRELEASE
commands =
    python setup.py clean --all
    python setup.py -q bdist_wheel --universal
    python setup.py -q sdist --formats=zip

# PYTEST CONFIG
[pytest]
filterwarnings =
    ignore:the matrix subclass is not the recommended way to represent matrices or deal with linear algebra*:FutureWarning
    ignore:the matrix subclass is not the recommended way to represent matrices or deal with linear algebra*:PendingDeprecationWarning
    once:check\_pickle is deprecated in joblib 0\.12 and will be removed in 0\.13:DeprecationWarning
    ignore:numpy.dtype size changed*:RuntimeWarning
    ignore:numpy.ufunc size changed*:RuntimeWarning
    ignore:More than.*figures have been opened*:RuntimeWarning
    ignore:The SafeConfigParser class has been renamed to ConfigParser in Python 3.2.*:DeprecationWarning
    ignore:future versions will not create a writeable array*:FutureWarning
    ignore:Numpy has detected that you (may be)*:DeprecationWarning
    ignore:Using or importing the ABCs from 'collections' instead of from 'collections.abc' is deprecated*:DeprecationWarning
addopts = --cov=src/secml

# PYTEST-COV CONFIG
[coverage:run]
branch = True

[coverage:report]
show_missing = True
